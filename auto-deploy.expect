#!/usr/bin/expect -f

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π finance-app –Ω–∞ Beget
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: expect auto-deploy.expect

set timeout 300
set server "45.80.69.195"
set user "root"
set password "2&UPny4fHa#P"
set app_dir "/root/finance-app"

puts "üöÄ –ù–∞—á–∏–Ω–∞—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –Ω–∞ Beget..."

# –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
spawn ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null $user@$server

expect {
    "password:" {
        send "$password\r"
        exp_continue
    }
    "# " {
        puts "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    }
    "$ " {
        puts "‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ"
    }
    timeout {
        puts "‚ùå –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è"
        exit 1
    }
}

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
set commands {
    "echo '–ù–∞—á–∏–Ω–∞–µ–º –¥–µ–ø–ª–æ–π...'"
    "cd /root"
    "rm -rf finance-app"
    "git clone https://github.com/zaharrrov001-hue/finans.git finance-app"
    "cd finance-app"
    "command -v node >/dev/null 2>&1 || (curl -fsSL https://deb.nodesource.com/setup_20.x | bash - && apt-get install -y nodejs)"
    "npm install"
    "npm run build"
    "command -v pm2 >/dev/null 2>&1 || npm install -g pm2"
    "mkdir -p logs"
    "pm2 delete finance-app 2>/dev/null || true"
    "pm2 start ecosystem.config.js"
    "pm2 save"
    "pm2 startup systemd -u root --hp /root || true"
    "pm2 status"
    "echo '–î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!'"
}

foreach cmd $commands {
    expect {
        "# " {}
        "$ " {}
        timeout {
            puts "‚ö†Ô∏è  –¢–∞–π–º–∞—É—Ç –æ–∂–∏–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞"
        }
    }
    
    send "$cmd\r"
    
    expect {
        -re "password:" {
            send "$password\r"
            exp_continue
        }
        -re "# " {}
        -re "$ " {}
        timeout {
            puts "‚ö†Ô∏è  –ö–æ–º–∞–Ω–¥–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–æ–ª–≥–æ: $cmd"
        }
    }
    
    # –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∫–æ–º–∞–Ω–¥–∞–º–∏
    sleep 1
}

expect {
    "# " {}
    "$ " {}
    timeout {}
}

send "exit\r"
expect eof

puts "\n‚úÖ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à—ë–Ω!"
puts "üåê –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω–æ –Ω–∞: http://$server:3000"

